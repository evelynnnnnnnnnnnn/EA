this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,n,a,s,i,o,r,l,d,c,h,g,u,m,C,p,v,I,_,b,T,E,M,f,S,y){"use strict";const L={chatHeader:64,pinnedMessages:53,blockedTextarea:50,dropAreaOffset:16};const A={video:{id:"video",locCode:"IM_CONTENT_CHAT_HEADER_VIDEOCALL",start:t=>{r.Messenger.startVideoCall(t)}},audio:{id:"audio",locCode:"IM_CONTENT_CHAT_HEADER_CALL_MENU_AUDIO",start:t=>{r.Messenger.startVideoCall(t,false)}},beta:{id:"beta",locCode:"IM_CONTENT_CHAT_HEADER_CALL_MENU_BETA_2",start:t=>{const e=v.Core.getStore().getters["chats/get"](t);l.CallManager.getInstance().createBetaCallRoom(e.chatId)}}};let x=t=>t,B;var P=babelHelpers.classPrivateFieldLooseKey("getDelimiter");var N=babelHelpers.classPrivateFieldLooseKey("getVideoCallItem");var O=babelHelpers.classPrivateFieldLooseKey("getAudioCallItem");var D=babelHelpers.classPrivateFieldLooseKey("getPersonalPhoneItem");var k=babelHelpers.classPrivateFieldLooseKey("getWorkPhoneItem");var H=babelHelpers.classPrivateFieldLooseKey("getInnerPhoneItem");var w=babelHelpers.classPrivateFieldLooseKey("getZoomItem");var R=babelHelpers.classPrivateFieldLooseKey("getUserPhoneHtml");var $=babelHelpers.classPrivateFieldLooseKey("isCallAvailable");var U=babelHelpers.classPrivateFieldLooseKey("getUser");var F=babelHelpers.classPrivateFieldLooseKey("isUser");var X=babelHelpers.classPrivateFieldLooseKey("requestCreateZoomConference");class z extends o.BaseMenu{constructor(){super();Object.defineProperty(this,X,{value:et});Object.defineProperty(this,F,{value:tt});Object.defineProperty(this,U,{value:Y});Object.defineProperty(this,$,{value:Q});Object.defineProperty(this,R,{value:Z});Object.defineProperty(this,w,{value:J});Object.defineProperty(this,H,{value:W});Object.defineProperty(this,k,{value:V});Object.defineProperty(this,D,{value:K});Object.defineProperty(this,O,{value:j});Object.defineProperty(this,N,{value:q});Object.defineProperty(this,P,{value:G});this.id="bx-im-chat-header-call-menu"}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:4,offsetTop:5}}getMenuClassName(){return"bx-im-messenger__scope bx-im-chat-header-call-button__scope"}getMenuItems(){return[babelHelpers.classPrivateFieldLooseBase(this,N)[N](),babelHelpers.classPrivateFieldLooseBase(this,O)[O](),babelHelpers.classPrivateFieldLooseBase(this,w)[w](),babelHelpers.classPrivateFieldLooseBase(this,P)[P](),babelHelpers.classPrivateFieldLooseBase(this,D)[D](),babelHelpers.classPrivateFieldLooseBase(this,k)[k](),babelHelpers.classPrivateFieldLooseBase(this,H)[H]()]}}function G(){return{delimiter:true}}function q(){const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$](this.context.dialogId);return{text:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_VIDEOCALL"),onclick:()=>{if(!t){return}A.video.start(this.context.dialogId);this.emit(z.events.onMenuItemClick,A.video);this.menuInstance.close()},disabled:!t}}function j(){const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$](this.context.dialogId);return{text:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_AUDIO"),onclick:()=>{if(!t){return}A.audio.start(this.context.dialogId);this.emit(z.events.onMenuItemClick,A.audio);this.menuInstance.close()},disabled:!t}}function K(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.personalMobile){return null}const e=u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_PERSONAL_PHONE");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.personalMobile),onclick:()=>{r.Messenger.startPhoneCall(t.personalMobile);this.menuInstance.close()}}}function V(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.workPhone){return null}const e=u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_WORK_PHONE");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.workPhone),onclick:()=>{r.Messenger.startPhoneCall(t.workPhone);this.menuInstance.close()}}}function W(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.innerPhone){return null}const e=u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_INNER_PHONE_MSGVER_1");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.innerPhone),onclick:()=>{r.Messenger.startPhoneCall(t.innerPhone);this.menuInstance.close()}}}function J(){const t=u.Extension.getSettings("im.v2.component.content.chat");const e=t.get("isZoomActive",false);if(!e){return null}const n=["bx-im-chat-header-call-button-menu__zoom","menu-popup-no-icon"];const a=t.get("isZoomFeatureAvailable",false);if(!a){n.push("--disabled")}return{className:n.join(" "),text:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM"),onclick:()=>{if(!a){BX.UI.InfoHelper.show("limit_video_conference_zoom");return}babelHelpers.classPrivateFieldLooseBase(this,X)[X](this.context.dialogId);this.menuInstance.close()}}}function Z(t,e){return u.Tag.render(B||(B=x`
			<span class="bx-im-chat-header-call-button-menu__phone_container">
				<span class="bx-im-chat-header-call-button-menu__phone_title">${0}</span>
				<span class="bx-im-chat-header-call-button-menu__phone_number">${0}</span>
			</span>
		`),t,e)}function Q(t){if(v.Core.getStore().getters["recent/calls/hasActiveCall"](t)&&l.CallManager.getInstance().getCurrentCallDialogId()===t){return true}if(v.Core.getStore().getters["recent/calls/hasActiveCall"]()){return false}const e=l.CallManager.getInstance().chatCanBeCalled(t);const n=p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.call,t);return e&&n}function Y(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}return v.Core.getStore().getters["users/get"](this.context.dialogId)}function tt(){return this.context.type===E.ChatType.user}function et(t){I.runAction(E.RestMethod.imV2CallZoomCreate,{data:{dialogId:t}}).catch((t=>{let e=u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CREATE_ERROR");const n=t.some((t=>t.code==="ZOOM_CONNECTED_ERROR"));if(n){const t=`/company/personal/user/${v.Core.getUserId()}/social_services/`;e=u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CONNECT_ERROR").replace("#HREF_START#",`<a href=${t}>`).replace("#HREF_END#","</>")}BX.UI.Notification.Center.notify({content:e})}))}z.events={onMenuItemClick:"onMenuItemClick"};const nt={props:{dialogId:{type:String,required:true}},emits:[],data(){return{lastCallType:""}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isActive(){if(this.$store.getters["recent/calls/hasActiveCall"](this.dialogId)&&l.CallManager.getInstance().getCurrentCallDialogId()===this.dialogId){return true}if(this.$store.getters["recent/calls/hasActiveCall"]()){return false}const t=l.CallManager.getInstance().chatCanBeCalled(this.dialogId);const e=p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.call,this.dialogId);return t&&e},isConference(){return this.dialog.type===E.ChatType.videoconf},callButtonText(){const t=A[this.lastCallType].locCode;return this.loc(t)}},created(){this.lastCallType=this.getLastCallChoice();this.subscribeToMenuItemClick()},methods:{startVideoCall(){if(!this.isActive){return}r.Messenger.startVideoCall(this.dialogId)},subscribeToMenuItemClick(){this.getCallMenu().subscribe(z.events.onMenuItemClick,(t=>{const{id:e}=t.getData();this.saveLastCallChoice(e)}))},getCallMenu(){if(!this.callMenu){this.callMenu=new z}return this.callMenu},onButtonClick(){if(!this.isActive){return}A[this.lastCallType].start(this.dialogId)},onMenuClick(){if(!this.shouldShowMenu()){return}this.getCallMenu().openMenu(this.dialog,this.$refs.menu)},onStartConferenceClick(){r.Messenger.openConference({code:this.dialog.public.code})},getLastCallChoice(){const t=i.LocalStorageManager.getInstance().get(E.LocalStorageKey.lastCallType,A.video.id);if(t===A.beta.id&&!this.isBitrixCallEnabled()){return A.video.id}return t},saveLastCallChoice(t){this.lastCallType=t;i.LocalStorageManager.getInstance().set(E.LocalStorageKey.lastCallType,t)},shouldShowMenu(){return this.isActive||this.isBitrixCallEnabled()},isBitrixCallEnabled(){return false},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div v-if="isConference" class="bx-im-chat-header-call-button__scope bx-im-chat-header-call-button__container --conference" @click="onStartConferenceClick">\n\t\t\t<div class="bx-im-chat-header-call-button__text">\n\t\t\t\t{{ loc('IM_CONTENT_CHAT_HEADER_START_CONFERENCE') }}\n\t\t\t</div>\n\t\t</div>\n\t\t<div\n\t\t\tv-else\n\t\t\tclass="bx-im-chat-header-call-button__scope bx-im-chat-header-call-button__container"\n\t\t\t:class="{'--disabled': !isActive}"\n\t\t\t@click="onButtonClick"\n\t\t>\n\t\t\t<div class="bx-im-chat-header-call-button__text">\n\t\t\t\t{{ callButtonText }}\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header-call-button__separator"></div>\n\t\t\t<div class="bx-im-chat-header-call-button__chevron_container" @click.stop="onMenuClick">\n\t\t\t\t<div class="bx-im-chat-header-call-button__chevron" ref="menu"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const at={[E.ChatEntityLinkType.tasks]:{className:"--task",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_TASK")},[E.ChatEntityLinkType.calendar]:{className:"--calendar",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_MEETING_MSGVER_1")},[E.ChatEntityLinkType.sonetGroup]:{className:"--group",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_GROUP_MSGVER_1")},[E.ChatEntityLinkType.mail]:{className:"--mail",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_MAIL_MSGVER_1")},[E.ChatEntityLinkType.contact]:{className:"--crm",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_CONTACT")},[E.ChatEntityLinkType.deal]:{className:"--crm",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_DEAL")},[E.ChatEntityLinkType.lead]:{className:"--crm",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_LEAD")},[E.ChatEntityLinkType.dynamic]:{className:"--crm",loc:u.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_DYNAMIC_ELEMENT")}};const st={name:"EntityLink",props:{dialogId:{type:String,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},entityType(){return this.dialog.entityLink.type},entityUrl(){return this.dialog.entityLink.url},containerClassName(){var t,e;return(t=(e=at[this.entityType])==null?void 0:e.className)!=null?t:""},linkText(){var t,e;return(t=(e=at[this.entityType])==null?void 0:e.loc)!=null?t:"Open entity"}},template:`\n\t\t<a :href="entityUrl" class="bx-im-chat-header-entity-link__container" :class="containerClassName" target="_blank">\n\t\t\t<div class="bx-im-chat-header-entity-link__icon"></div>\n\t\t\t<div class="bx-im-chat-header-entity-link__text">{{ linkText }}</div>\n\t\t\t<div class="bx-im-chat-header-entity-link__arrow"></div>\n\t\t</a>\n\t`};const it={[E.ChatType.openChannel]:"IM_CONTENT_CHAT_HEADER_CHANNEL_USER_COUNT",[E.ChatType.channel]:"IM_CONTENT_CHAT_HEADER_CHANNEL_USER_COUNT",default:"IM_CONTENT_CHAT_HEADER_USER_COUNT"};const ot={name:"GroupChatTitle",components:{EditableChatTitle:S.EditableChatTitle,EntityLink:st,LineLoader:S.LineLoader,FadeAnimation:d.FadeAnimation},props:{dialogId:{type:String,required:true}},emits:["membersClick","newTitle"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},hasEntityLink(){var t;return Boolean((t=this.dialog.entityLink)==null?void 0:t.url)},userCounterPhraseCode(){var t;return(t=it[this.dialog.type])!=null?t:it.default},userCounterText(){return u.Loc.getMessagePlural(this.userCounterPhraseCode,this.dialog.userCounter,{"#COUNT#":this.dialog.userCounter})}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<EditableChatTitle :dialogId="dialogId" @newTitleSubmit="$emit('newTitle', $event)" />\n\t\t\t<LineLoader v-if="!dialog.inited" :width="50" :height="16" />\n\t\t\t<FadeAnimation :duration="100">\n\t\t\t\t<div v-if="dialog.inited" class="bx-im-chat-header__subtitle_container">\n\t\t\t\t\t<div\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_MEMBERS')"\n\t\t\t\t\t\t@click="$emit('membersClick')"\n\t\t\t\t\t\tclass="bx-im-chat-header__subtitle_content --click"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ userCounterText }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<EntityLink v-if="hasEntityLink" :dialogId="dialogId" />\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t</div>\n\t`};const rt=60*1e3;const lt={name:"UserTitle",components:{ChatTitle:S.ChatTitle},props:{dialogId:{type:String,required:true}},data(){return{userLastOnlineText:""}},computed:{userPosition(){return this.$store.getters["users/getPosition"](this.dialogId)},userLastOnline(){return this.$store.getters["users/getLastOnline"](this.dialogId)},userLink(){return c.Utils.user.getProfileLink(this.dialogId)}},watch:{userLastOnline(t){this.userLastOnlineText=t}},created(){this.updateUserOnline();this.userLastOnlineInterval=setInterval(this.updateUserOnline,rt)},beforeUnmount(){clearInterval(this.userLastOnlineInterval)},methods:{updateUserOnline(){this.userLastOnlineText=this.$store.getters["users/getLastOnline"](this.dialogId)}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<div class="bx-im-chat-header__title --user">\n\t\t\t\t<a :href="userLink" target="_blank" class="bx-im-chat-header__title_container">\n\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t</a>\n\t\t\t\t<span class="bx-im-chat-header__user-status">{{ userLastOnlineText }}</span>\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header__subtitle_container">\n\t\t\t\t<div class="bx-im-chat-header__subtitle_content">{{ userPosition }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const dt={name:"ChatHeader",components:{Avatar:S.Avatar,AddToChat:s.AddToChat,CallButton:nt,GroupChatTitle:ot,UserTitle:lt,LineLoader:S.LineLoader,FadeAnimation:d.FadeAnimation},props:{dialogId:{type:String,default:""},currentSidebarPanel:{type:String,default:""}},emits:["toggleRightPanel","toggleSearchPanel","toggleMembersPanel"],data(){return{showAddToChatPopup:false}},computed:{AvatarSize:()=>S.AvatarSize,user(){return this.$store.getters["users/get"](this.dialogId,true)},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isInited(){return this.dialog.inited},isUser(){return this.dialog.type===E.ChatType.user},isBot(){if(!this.isUser){return false}return this.user.bot===true},isChat(){return!this.isUser},chatId(){return this.dialog.chatId},userLink(){return c.Utils.user.getProfileLink(this.dialogId)},showCallButton(){if(this.isBot){return false}return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.call,this.dialogId)},showInviteButton(){if(this.isBot){return false}return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.extend,this.dialogId)},showSidebarButton(){return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.openSidebar,this.dialogId)},canChangeAvatar(){return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.avatar,this.dialogId)},isSidebarOpened(){return this.currentSidebarPanel.length>0},isMessageSearchActive(){return this.currentSidebarPanel===E.SidebarDetailBlock.messageSearch}},methods:{toggleRightPanel(){if(this.currentSidebarPanel){C.EventEmitter.emit(E.EventType.sidebar.close,{panel:""});return}C.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.main,dialogId:this.dialogId})},toggleSearchPanel(){if(this.isMessageSearchActive){C.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.messageSearch});return}C.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.messageSearch,dialogId:this.dialogId})},onMembersClick(){if(!this.isInited){return}if(this.currentSidebarPanel===E.SidebarDetailBlock.members){C.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.members});return}C.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.members,dialogId:this.dialogId})},onNewTitleSubmit(t){this.getChatService().renameChat(this.dialogId,t).catch((()=>{BX.UI.Notification.Center.notify({content:this.loc("IM_CONTENT_CHAT_HEADER_RENAME_ERROR")})}))},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},openInvitePopup(){this.showAddToChatPopup=true},onAvatarClick(){if(!this.isChat||!this.canChangeAvatar){return}this.$refs.avatarInput.click()},async onAvatarSelect(t){const e=t.target;const n=e.files[0];if(!n){return}const a=await this.getChatService().prepareAvatar(n);if(!a){return}void this.getChatService().changeAvatar(this.dialog.chatId,a)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="bx-im-chat-header__scope bx-im-chat-header__container">\n\t\t\t<div class="bx-im-chat-header__left">\n\t\t\t\t<slot name="left">\n\t\t\t\t\t<div class="bx-im-chat-header__avatar" :class="{'--can-change': canChangeAvatar}" @click="onAvatarClick">\n\t\t\t\t\t\t<Avatar v-if="isChat" :dialogId="dialogId" :size="AvatarSize.L" />\n\t\t\t\t\t\t<a v-else :href="userLink" target="_blank">\n\t\t\t\t\t\t\t<Avatar :dialogId="dialogId" :size="AvatarSize.L" />\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="file" \n\t\t\t\t\t\t@change="onAvatarSelect" \n\t\t\t\t\t\taccept="image/*" \n\t\t\t\t\t\tclass="bx-im-chat-header__avatar_input" \n\t\t\t\t\t\tref="avatarInput"\n\t\t\t\t\t>\n\t\t\t\t\t<GroupChatTitle\n\t\t\t\t\t\tv-if="isChat"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t@membersClick="onMembersClick"\n\t\t\t\t\t\t@newTitle="onNewTitleSubmit"\n\t\t\t\t\t/>\n\t\t\t\t\t<UserTitle v-else :dialogId="dialogId" />\n\t\t\t\t</slot>\n\t\t\t</div>\n\t\t\t<LineLoader v-if="!isInited" :width="45" :height="22" />\n\t\t\t<FadeAnimation :duration="100">\n\t\t\t\t<div v-if="isInited" class="bx-im-chat-header__right">\n\t\t\t\t\t<slot name="before-actions"></slot>\n\t\t\t\t\t<CallButton v-if="showCallButton" :dialogId="dialogId" />\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showInviteButton"\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_INVITE_POPUP_TITLE')"\n\t\t\t\t\t\t:class="{'--active': showAddToChatPopup}"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --add-people"\n\t\t\t\t\t\t@click="openInvitePopup" \n\t\t\t\t\t\tref="add-members"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div \n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_SEARCH')"\n\t\t\t\t\t\t:class="{'--active': isMessageSearchActive}"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --search" \n\t\t\t\t\t\t@click="toggleSearchPanel"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showSidebarButton"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --panel"\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_SIDEBAR')"\n\t\t\t\t\t\t:class="{'--active': isSidebarOpened}"\n\t\t\t\t\t\t@click="toggleRightPanel" \n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['add-members'] || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: 15, offsetLeft: -300}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const ct={props:{dialogId:{type:String,required:true},container:{type:Object,required:true}},data(){return{showDropArea:false,lastDropAreaEnterTarget:null}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},hasPinnedMessages(){return this.$store.getters["messages/pin/getPinned"](this.dialog.chatId).length>0},dropAreaStyles(){let t=L.dropAreaOffset+L.chatHeader;if(this.hasPinnedMessages){t+=L.pinnedMessages}return{top:`${t}px`}}},watch:{container:{immediate:true,handler(t){if(!u.Type.isElementNode(t)){return}this.bindEvents()}}},beforeUnmount(){this.unbindEvents()},methods:{bindEvents(){u.Event.bind(this.container,"dragenter",this.onDragEnter);u.Event.bind(this.container,"dragleave",this.onDragLeave);u.Event.bind(this.container,"dragover",this.onDragOver);u.Event.bind(this.container,"drop",this.onDrop)},unbindEvents(){u.Event.unbind(this.container,"dragenter",this.onDragEnter);u.Event.unbind(this.container,"dragleave",this.onDragLeave);u.Event.unbind(this.container,"dragover",this.onDragOver);u.Event.unbind(this.container,"drop",this.onDrop)},async onDragEnter(t){t.stopPropagation();t.preventDefault();const e=await h.hasDataTransferOnlyFiles(t.dataTransfer,false);if(!e){return}this.lastDropAreaEnterTarget=t.target;this.showDropArea=true},onDragLeave(t){t.stopPropagation();t.preventDefault();if(this.lastDropAreaEnterTarget!==t.target){return}this.showDropArea=false},onDragOver(t){t.preventDefault()},async onDrop(t){t.preventDefault();const e=await h.getFilesFromDataTransfer(t.dataTransfer);this.getUploadingService().addFilesFromInput(e,this.dialogId);this.showDropArea=false},getUploadingService(){if(!this.uploadingService){this.uploadingService=y.UploadingService.getInstance()}return this.uploadingService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<Transition name="drop-area-fade">\n\t\t\t<div v-if="showDropArea" :style="dropAreaStyles" class="bx-im-content-chat-drop-area__container bx-im-content-chat-drop-area__scope">\n\t\t\t\t<div class="bx-im-content-chat-drop-area__box">\n\t\t\t\t\t<span class="bx-im-content-chat-drop-area__icon"></span>\n\t\t\t\t\t<label class="bx-im-content-chat-drop-area__label-text">\n\t\t\t\t\t\t{{ loc('IM_CONTENT_DROP_AREA') }}\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Transition>\n\t`};const ht="rgba(0, 0, 0, 0.1)";const gt="rgba(0, 0, 0, 0.2)";const ut="#fff";const mt={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isMuted(){return this.dialog.muteList.includes(v.Core.getUserId())},buttonText(){const t=this.loc("IM_CONTENT_BLOCKED_TEXTAREA_ENABLE_NOTIFICATIONS");const e=this.loc("IM_CONTENT_BLOCKED_TEXTAREA_DISABLE_NOTIFICATIONS");return this.isMuted?t:e},buttonColorScheme(){return{borderColor:E.Color.transparent,backgroundColor:ht,iconColor:ut,textColor:ut,hoverColor:gt}}},methods:{onButtonClick(){if(this.isMuted){this.getChatService().unmuteChat(this.dialogId);return}this.getChatService().muteChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:customColorScheme="buttonColorScheme"\n\t\t\t\t:text="buttonText"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const Ct={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHAT')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const pt={name:"LoadingBar",data(){return{}},template:`\n\t\t<div class="bx-im-content-chat__loading-bar"></div>\n\t`};const vt={mounted(t,e){e.instance.textareaResizeManager.observeTextarea(t)},beforeUnmount(t,e){e.instance.textareaResizeManager.unobserveTextarea(t)}};const It={name:"BaseChatContent",components:{ChatHeader:dt,ChatDialog:T.ChatDialog,ChatTextarea:f.ChatTextarea,ChatSidebar:a.ChatSidebar,DropArea:ct,MutePanel:mt,JoinPanel:Ct,LoadingBar:pt},directives:{"textarea-observer":vt},props:{dialogId:{type:String,default:""},commentsOpened:{type:Boolean,default:false}},data(){return{currentSidebarPanel:"",textareaHeight:0,showLoadingBar:false}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},canSend(){return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.send,this.dialog.dialogId)},isGuest(){return this.dialog.role===E.UserRole.guest},containerClasses(){const t=this.$store.getters["application/settings/get"](E.Settings.appearance.alignment);return[`--${t}-align`]},backgroundStyle(){return g.ThemeManager.getCurrentBackgroundStyle()},dialogContainerStyle(){let t=this.textareaHeight;if(!this.canSend){t=L.blockedTextarea}return{height:`calc(100% - ${L.chatHeader}px - ${t}px)`}}},watch:{textareaHeight(t,e){if(!this.dialog.inited||e===0){return}C.EventEmitter.emit(E.EventType.dialog.scrollToBottom,{chatId:this.dialog.chatId,animation:false})}},created(){this.initTextareaResizeManager();this.bindEvents()},beforeUnmount(){this.unbindEvents()},methods:{initTextareaResizeManager(){this.textareaResizeManager=new n.ResizeManager;this.textareaResizeManager.subscribe(n.ResizeManager.events.onHeightChange,this.onTextareaHeightChange)},onTextareaMount(){const t=this.$refs["textarea-container"];this.textareaHeight=t.clientHeight},onTextareaHeightChange(t){const{newHeight:e}=t.getData();this.textareaHeight=e},onChangeSidebarPanel({panel:t}){this.currentSidebarPanel=t},onShowLoadingBar(t){const{dialogId:e}=t.getData();if(e!==this.dialogId){return}this.showLoadingBar=true},onHideLoadingBar(t){const{dialogId:e}=t.getData();if(e!==this.dialogId){return}this.showLoadingBar=false},bindEvents(){C.EventEmitter.subscribe(E.EventType.dialog.showLoadingBar,this.onShowLoadingBar);C.EventEmitter.subscribe(E.EventType.dialog.hideLoadingBar,this.onHideLoadingBar)},unbindEvents(){C.EventEmitter.unsubscribe(E.EventType.dialog.showLoadingBar,this.onShowLoadingBar);C.EventEmitter.unsubscribe(E.EventType.dialog.hideLoadingBar,this.onHideLoadingBar)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__scope bx-im-content-chat__container" :class="containerClasses" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat__content" ref="content">\n\t\t\t\t<slot name="header" :currentSidebarPanel="currentSidebarPanel">\n\t\t\t\t\t<ChatHeader :dialogId="dialogId" :key="dialogId" :currentSidebarPanel="currentSidebarPanel"/>\n\t\t\t\t</slot>\n\t\t\t\t<div :style="dialogContainerStyle" class="bx-im-content-chat__dialog_container">\n\t\t\t\t\t<Transition name="loading-bar-transition">\n\t\t\t\t\t\t<LoadingBar v-if="showLoadingBar" />\n\t\t\t\t\t</Transition>\n\t\t\t\t\t<div class="bx-im-content-chat__dialog_content">\n\t\t\t\t\t\t<slot name="dialog">\n\t\t\t\t\t\t\t<ChatDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t\t\t\t</slot>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- Textarea --\x3e\n\t\t\t\t<div v-if="canSend" v-textarea-observer class="bx-im-content-chat__textarea_container" ref="textarea-container">\n\t\t\t\t\t<slot name="textarea" :onTextareaMount="onTextareaMount">\n\t\t\t\t\t\t<ChatTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t\t\t</slot>\n\t\t\t\t</div>\n\t\t\t\t<slot v-else-if="isGuest" name="join-panel">\n\t\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t\t</slot>\n\t\t\t\t<MutePanel v-else :dialogId="dialogId" />\n\t\t\t\t\x3c!-- End textarea --\x3e\n\t\t\t\t<DropArea :dialogId="dialogId" :container="$refs.content || {}" :key="dialogId" />\n\t\t\t</div>\n\t\t\t<ChatSidebar \n\t\t\t\tv-if="dialogId.length > 0" \n\t\t\t\t:originDialogId="dialogId"\n\t\t\t\t:isActive="!commentsOpened"\n\t\t\t\t@changePanel="onChangeSidebarPanel" \n\t\t\t/>\n\t\t</div>\n\t`};const _t={name:"CommentsButton",props:{dialogId:{type:String,required:true},counter:{type:Number,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)}},template:`\n\t\t<div class="bx-im-dialog-channel__comments-button">\n\t\t\t<div class="bx-im-dialog-channel__comments-button_counter">\n\t\t\t\t{{ counter }}\n\t\t\t</div>\n\t\t</div>\n\t`};class bt extends M.MessageMenu{getMenuItems(){return[this.getCopyItem(),this.getCopyLinkItem(),this.getCopyFileItem(),this.getPinItem(),this.getForwardItem(),this.getDelimiter(),this.getMarkItem(),this.getFavoriteItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}}const Tt={name:"ChannelMessageList",components:{MessageList:M.MessageList},props:{dialogId:{type:String,required:true}},computed:{ChannelMessageMenu:()=>bt},template:`\n\t\t<MessageList :dialogId="dialogId" :messageMenuClass="ChannelMessageMenu" />\n\t`};const Et={name:"ChannelDialog",components:{ChatDialog:T.ChatDialog,ChannelMessageList:Tt,CommentsButton:_t},props:{dialogId:{type:String,required:true}},data(){return{localCommentsCounterMap:{}}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},isGuest(){return this.dialog.role===E.UserRole.guest},isChatLayout(){return this.layout.name===E.Layout.chat.name},realCommentsWithCounter(){return this.$store.getters["counters/getCommentsWithCounter"](this.dialog.chatId)},realCommentsCounterMap(){const t={};this.realCommentsWithCounter.forEach((e=>{t[e]=this.$store.getters["counters/getSpecificCommentsCounter"]({channelId:this.dialog.chatId,commentChatId:e})}));return t},localCommentsQueue(){return Object.keys(this.localCommentsCounterMap).map((t=>Number(t)))},localTotalCommentsCounter(){let t=0;Object.values(this.localCommentsCounterMap).forEach((e=>{t+=e}));return t},showCommentsButton(){return this.isChatLayout&&this.localCommentsQueue.length>0}},watch:{realCommentsWithCounter(t,e){const n=this.getAddedElements(t,e);n.forEach((t=>{this.localCommentsCounterMap[t]=this.realCommentsCounterMap[t]}));const a=this.getRemovedElements(t,e);a.forEach((t=>{delete this.localCommentsCounterMap[t]}))}},created(){this.localCommentsCounterMap={...this.realCommentsCounterMap}},methods:{async onCommentsButtonClick(){const[t]=this.localCommentsQueue;const e=this.$store.getters["messages/comments/getMessageIdByChatId"](t);if(e){this.$refs.dialog.goToMessageContext(e);delete this.localCommentsCounterMap[t];return}await this.goToMessageContextByCommentsChatId(t);delete this.localCommentsCounterMap[t]},async goToMessageContextByCommentsChatId(t){this.$refs.dialog.showLoadingBar();const e=await this.$refs.dialog.getMessageService().loadContextByChatId(t).catch((t=>{console.error("ChannelDialog: goToMessageContextByCommentsChatId error",t)}));this.$refs.dialog.hideLoadingBar();if(!e){console.error("ChannelDialog: no messageId after loading context")}await this.$nextTick();this.$refs.dialog.getScrollManager().scrollToMessage(e);await this.$nextTick();this.$refs.dialog.highlightMessage(e)},getAddedElements(t,e){return t.filter((t=>!e.includes(t)))},getRemovedElements(t,e){return e.filter((e=>!t.includes(e)))}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :resetOnExit="isGuest">\n\t\t\t<template #message-list>\n\t\t\t\t<ChannelMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #additional-float-button>\n\t\t\t\t<Transition name="float-button-transition">\n\t\t\t\t\t<CommentsButton\n\t\t\t\t\t\tv-if="showCommentsButton"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t:counter="localTotalCommentsCounter"\n\t\t\t\t\t\t@click="onCommentsButtonClick"\n\t\t\t\t\t\tkey="comments"\n\t\t\t\t\t/>\n\t\t\t\t</Transition>\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const Mt={name:"ChannelHeader",components:{ChatHeader:dt},props:{dialogId:{type:String,default:""},currentSidebarPanel:{type:String,default:""}},template:`\n\t\t<ChatHeader :dialogId="dialogId" :currentSidebarPanel="currentSidebarPanel" />\n\t`};const ft={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const St={name:"ChannelTextarea",components:{ChatTextarea:f.ChatTextarea},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:withCreateMenu="false"\n\t\t\t:withMarket="false"\n\t\t\tclass="bx-im-channel-send-panel__container"\n\t\t/>\n\t`};const yt={name:"ChannelContent",components:{BaseChatContent:It,ChannelHeader:Mt,ChannelDialog:Et,ChannelTextarea:St,JoinPanel:ft},props:{dialogId:{type:String,required:true},commentsOpened:{type:Boolean,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId" :commentsOpened="commentsOpened">\n\t\t\t<template #header="{ currentSidebarPanel }">\n\t\t\t\t<ChannelHeader :dialogId="dialogId" :currentSidebarPanel="currentSidebarPanel" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #dialog>\n\t\t\t\t<ChannelDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<ChannelTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const Lt={data(){return{}},computed:{iconClass(){return this.isEmptyRecent?"--empty":"--default"},text(){if(this.isEmptyRecent){return this.loc("IM_CONTENT_CHAT_NO_CHATS_START_MESSAGE")}if(this.isChannelLayout){return this.loc("IM_CONTENT_CHANNEL_START_MESSAGE")}return this.loc("IM_CONTENT_CHAT_START_MESSAGE_V2")},subtext(){return""},isEmptyRecent(){return y.RecentService.getInstance().getCollection().length===0},isChannelLayout(){return this.layout.name===E.Layout.channel.name},layout(){return this.$store.getters["application/getLayout"]},backgroundStyle(){return g.ThemeManager.getCurrentBackgroundStyle()}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat-start__container" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat-start__content">\n\t\t\t\t<div class="bx-im-content-chat-start__icon" :class="iconClass"></div>\n\t\t\t\t<div class="bx-im-content-chat-start__title">\n\t\t\t\t\t{{ text }}\n\t\t\t\t</div>\n\t\t\t\t<div v-if="subtext" class="bx-im-content-chat-start__subtitle">\n\t\t\t\t\t{{ subtext }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class At{async updateLastActivityDate(t){if(this.isPullServerWithUserStatusSupport()){const e=await this.getUserActivityFromPull(t);if(!e){return Promise.resolve()}return this.updateUserModel(t,{lastActivityDate:e})}const e=await this.requestUserData(t);return this.updateUserModel(t,e)}async getUserActivityFromPull(t){const e=await v.Core.getPullClient().getUsersLastSeen([t]).catch((t=>{console.error("UserService: error getting user activity from P&P",t)}));if(!u.Type.isNumber(e[t])){return null}const n=e[t]*1e3;return new Date(Date.now()-n)}async requestUserData(t){_.Logger.warn(`UserService: get actual user data for - ${t}`);const e=await v.Core.getRestClient().callMethod(E.RestMethod.imUserGet,{ID:t}).catch((t=>{console.error("UserService: error getting user data",t)}));return e.data()}async updateUserModel(t,e){_.Logger.warn("UserService: update user data",e);return v.Core.getStore().dispatch("users/update",{id:t,fields:e})}isPullServerWithUserStatusSupport(){return v.Core.getPullClient().isJsonRpc()}}const xt={name:"ChatOpener",components:{BaseChatContent:It,ChannelContent:yt,EmptyState:Lt},props:{dialogId:{type:String,required:true},commentsOpened:{type:Boolean,required:true}},emits:["close"],data(){return{}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===E.ChatType.user},isChannel(){return[E.ChatType.channel,E.ChatType.openChannel].includes(this.dialog.type)},isGuest(){return this.dialog.role===E.UserRole.guest}},watch:{dialogId(t,e){_.Logger.warn(`ChatContent: switching from ${e||"empty"} to ${t}`);this.onChatChange()}},created(){if(!this.dialogId){return}this.onChatChange()},methods:{async onChatChange(){if(this.dialogId===""){return}if(c.Utils.dialog.isExternalId(this.dialogId)){const t=await this.getChatService().prepareDialogId(this.dialogId);void e.LayoutManager.getInstance().setLayout({name:E.Layout.chat.name,entityId:t,contextId:this.layout.contextId});return}if(this.dialog.inited){_.Logger.warn(`ChatContent: chat ${this.dialogId} is already loaded`);if(this.isUser){const t=parseInt(this.dialog.dialogId,10);void this.getUserService().updateLastActivityDate(t)}else if(this.isChannel&&!this.isGuest){_.Logger.warn(`ChatContent: channel ${this.dialogId} is loaded, loading comments metadata`);void this.getChatService().loadCommentInfo(this.dialogId)}return}if(this.dialog.loading){_.Logger.warn(`ChatContent: chat ${this.dialogId} is loading`);return}if(this.layout.contextId){await this.loadChatWithContext();return}await this.loadChat()},async loadChatWithContext(){_.Logger.warn(`ChatContent: loading chat ${this.dialogId} with context - ${this.layout.contextId}`);await this.getChatService().loadChatWithContext(this.dialogId,this.layout.contextId).catch((t=>{this.handleChatLoadError(t);_.Logger.error(t);r.Messenger.openChat()}));_.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded with context of ${this.layout.contextId}`)},async loadChat(){_.Logger.warn(`ChatContent: loading chat ${this.dialogId}`);await this.getChatService().loadChatWithMessages(this.dialogId).catch((t=>{this.handleChatLoadError(t);_.Logger.error(t);r.Messenger.openChat()}));_.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded`)},handleChatLoadError(t){const[e]=t;if(e.code==="ACCESS_DENIED"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR"))}else if(e.code==="MESSAGE_NOT_FOUND"){this.showNotification(this.loc("IM_CONTENT_CHAT_CONTEXT_MESSAGE_NOT_FOUND"))}},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},getUserService(){if(!this.userService){this.userService=new At}return this.userService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-default-chat__container">\n\t\t\t<EmptyState v-if="!dialogId" />\n\t\t\t<ChannelContent v-else-if="isChannel" :dialogId="dialogId" :commentsOpened="commentsOpened" />\n\t\t\t<BaseChatContent\n\t\t\t\tv-else\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\tclass="bx-im-content-comments__container"\n\t\t\t/>\n\t\t</div>\n\t`};const Bt={subscribe(t){v.Core.getStore().dispatch("chats/unmute",{dialogId:t});return I.runAction(E.RestMethod.imV2ChatCommentSubscribe,{data:{dialogId:t}}).catch((t=>{console.error("CommentsService: subscribe error",t)}))},unsubscribe(t){v.Core.getStore().dispatch("chats/mute",{dialogId:t});return I.runAction(E.RestMethod.imV2ChatCommentUnsubscribe,{data:{dialogId:t}}).catch((t=>{console.error("CommentsService: unsubscribe error",t)}))}};const Pt={name:"FollowToggle",components:{Toggle:S.Toggle},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ToggleSize:()=>S.ToggleSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isFollowed(){return!this.dialog.muteList.includes(v.Core.getUserId())}},methods:{onToggleClick(){if(this.isFollowed){Bt.unsubscribe(this.dialogId);return}Bt.subscribe(this.dialogId)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div @click="onToggleClick" class="bx-im-comments-header-follow__container">\n\t\t\t<div class="bx-im-comments-header-follow__text">{{ loc('IM_CONTENT_COMMENTS_FOLLOW_TOGGLE_TEXT') }}</div>\n\t\t\t<Toggle :size="ToggleSize.M" :isEnabled="isFollowed" />\n\t\t</div>\n\t`};const Nt={name:"CommentsHeader",components:{ChatHeader:dt,Avatar:S.Avatar,FollowToggle:Pt},props:{dialogId:{type:String,default:""},channelId:{type:String,required:true},currentSidebarPanel:{type:String,default:""}},computed:{AvatarSize:()=>S.AvatarSize,channel(){return this.$store.getters["chats/get"](this.channelId,true)},showFollowToggle(){return p.PermissionManager.getInstance().canPerformAction(E.ChatActionType.followComments,this.dialogId)}},methods:{onBackClick(){C.EventEmitter.emit(E.EventType.dialog.closeComments)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<ChatHeader\n\t\t\t:dialogId="dialogId"\n\t\t\t:currentSidebarPanel="currentSidebarPanel"\n\t\t\tclass="bx-im-comment-header__container"\n\t\t>\n\t\t\t<template #left>\n\t\t\t\t<div @click="onBackClick" class="bx-im-comment-header__back"></div>\n\t\t\t\t<div class="bx-im-comment-header__info">\n\t\t\t\t\t<div class="bx-im-comment-header__title">{{ loc('IM_CONTENT_COMMENTS_HEADER_TITLE') }}</div>\n\t\t\t\t\t<div class="bx-im-comment-header__subtitle">\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_avatar">\n\t\t\t\t\t\t\t<Avatar :dialogId="channelId" :size="AvatarSize.XS" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_text">{{ channel.name }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-if="showFollowToggle" #before-actions>\n\t\t\t\t<FollowToggle :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatHeader>\n\t`};const Ot={name:"CommentsDialogLoader",data(){return{}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-comments-dialog-loader__container">\n\t\t\t<div class="bx-im-comments-dialog-loader__spinner"></div>\n\t\t</div>\n\t`};class Dt extends M.MessageMenu{getMenuItems(){return[this.getReplyItem(),this.getCopyItem(),this.getCopyFileItem(),this.getDelimiter(),this.getFavoriteItem(),this.getDelimiter(),this.getCreateItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}getReplyItem(){if(this.isPostMessage()){return null}return super.getReplyItem()}getEditItem(){if(this.isPostMessage()){return null}return super.getEditItem()}getDeleteItem(){if(this.isPostMessage()){return null}return super.getDeleteItem()}getCreateItem(){if(this.isPostMessage()){return null}return super.getCreateItem()}isPostMessage(){const{type:t}=this.store.getters["chats/getByChatId"](this.context.chatId);return[E.ChatType.openChannel,E.ChatType.channel].includes(t)}}const kt={name:"CommentsMessageList",components:{MessageList:M.MessageList,CommentsDialogLoader:Ot,AuthorGroup:M.AuthorGroup,...M.MessageComponents},props:{dialogId:{type:String,required:true}},computed:{CommentsMessageMenu:()=>Dt,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},showPostMessage(){return this.dialog.inited&&!this.dialog.hasPrevPage},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)},postAuthorGroup(){if(!this.dialog.inited){return null}const t=new M.CollectionManager(this.dialogId);return t.formatAuthorGroup(this.postMessage)}},methods:{onPostMessageMouseUp(t,e){this.$refs.messageList.onMessageMouseUp(t,e)},getMessageComponentName(t){return new M.MessageComponentManager(t).getName()}},template:`\n\t\t<MessageList\n\t\t\t:dialogId="dialogId"\n\t\t\t:messageMenuClass="CommentsMessageMenu"\n\t\t\tref="messageList"\n\t\t>\n\t\t\t<template #loader>\n\t\t\t\t<CommentsDialogLoader />\n\t\t\t</template>\n\t\t\t<template v-if="showPostMessage" #before-messages>\n\t\t\t\t<div class="bx-im-comments-message-list__channel-post">\n\t\t\t\t\t<AuthorGroup :item="postAuthorGroup">\n\t\t\t\t\t\t<template #message>\n\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t:is="getMessageComponentName(postMessage)"\n\t\t\t\t\t\t\t\t:item="postMessage"\n\t\t\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t\t\t:key="postMessage.id"\n\t\t\t\t\t\t\t\t@mouseup="onPostMessageMouseUp(postMessage, $event)"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</AuthorGroup>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</MessageList>\n\t`};const Ht={name:"CommentsDialog",components:{ChatDialog:T.ChatDialog,CommentsMessageList:kt,PinnedMessages:T.PinnedMessages},props:{dialogId:{type:String,required:true}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)}},methods:{async goToPostMessageContext(){const t=this.$refs.dialog;const e=this.dialogInited&&!this.dialog.hasPrevPage;if(e){await t.getScrollManager().animatedScrollToMessage(this.postMessageId);t.highlightMessage(this.postMessageId);return}t.showLoadingBar();await t.getMessageService().loadFirstPage().catch((t=>{_.Logger.error("goToMessageContext error",t)}));await this.$nextTick();t.hideLoadingBar();t.getScrollManager().scrollToMessage(this.postMessageId);await this.$nextTick();t.highlightMessage(this.postMessageId)},onPinnedPostMessageClick(){this.goToPostMessageContext()}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :saveScrollOnExit="false" :resetOnExit="true">\n\t\t\t<template v-if="dialogInited" #pinned-panel>\n\t\t\t\t<PinnedMessages\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:messages="[postMessage]"\n\t\t\t\t\t@messageClick="onPinnedPostMessageClick"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #message-list>\n\t\t\t\t<CommentsMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const wt={name:"CommentsTextarea",components:{ChatTextarea:f.ChatTextarea},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:withMarket="false"\n\t\t\tclass="bx-im-comments-send-panel__container"\n\t\t/>\n\t`};const Rt={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const $t={name:"CommentsContent",components:{BaseChatContent:It,CommentsHeader:Nt,CommentsDialog:Ht,CommentsTextarea:wt,JoinPanel:Rt},props:{dialogId:{type:String,required:true},channelId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #header="{ currentSidebarPanel }">\n\t\t\t\t<CommentsHeader\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:channelId="channelId"\n\t\t\t\t\t:currentSidebarPanel="currentSidebarPanel"\n\t\t\t\t\t:key="dialogId"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #dialog>\n\t\t\t\t<CommentsDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<CommentsTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const Ut={name:"CommentsOpener",components:{CommentsContent:$t},props:{postId:{type:Number,required:true},channelId:{type:String,required:true}},emits:["close"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/getByChatId"](this.commentsChatId)},commentInfo(){return this.$store.getters["messages/comments/getByMessageId"](this.postId)},commentsChatId(){return this.commentInfo.chatId},commentsDialogId(){if(!this.dialog){return""}return this.dialog.dialogId}},created(){this.onCreated()},methods:{async onCreated(){await this.loadChat()},async loadChat(){_.Logger.warn(`CommentsContent: loading comments for post ${this.postId}`);await this.getChatService().loadComments(this.postId).catch((t=>{this.handleChatLoadError(t);_.Logger.error(t);this.$emit("close")}));_.Logger.warn(`CommentsContent: comments for post ${this.postId} are loaded`)},handleChatLoadError(t){const[e]=t;if(e.code==="ACCESS_DENIED"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR"))}},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService}},template:`\n\t\t<div class="bx-im-content-comments__container">\n\t\t\t<CommentsContent :dialogId="commentsDialogId" :channelId="channelId" />\n\t\t</div>\n\t`};const Ft={name:"ChatContent",components:{ChatOpener:xt,CommentsOpener:Ut},props:{entityId:{type:String,default:""}},data(){return{commentsPostId:0,commentsAnimationFlag:false}},computed:{layout(){return this.$store.getters["application/getLayout"]},showComments(){return this.commentsPostId>0}},watch:{layout(t){this.closeComments()}},created(){C.EventEmitter.subscribe(E.EventType.dialog.openComments,this.onOpenComments);C.EventEmitter.subscribe(E.EventType.dialog.closeComments,this.onCloseComments)},beforeUnmount(){C.EventEmitter.unsubscribe(E.EventType.dialog.openComments,this.onOpenComments);C.EventEmitter.unsubscribe(E.EventType.dialog.closeComments,this.onCloseComments)},methods:{onOpenComments(t){const{messageId:e}=t.getData();this.commentsPostId=e;this.commentsAnimationFlag=true},onCloseComments(){this.closeComments()},closeComments(){this.commentsPostId=0},onCommentsAnimationEnd(){this.commentsAnimationFlag=false}},template:`\n\t\t<ChatOpener\n\t\t\t:commentsOpened="showComments"\n\t\t\t:dialogId="entityId"\n\t\t\t:class="{'--comments-show-animation': commentsAnimationFlag}"\n\t\t/>\n\t\t<Transition name="comments-content" @after-enter="onCommentsAnimationEnd">\n\t\t\t<CommentsOpener\n\t\t\t\tv-if="showComments"\n\t\t\t\t:postId="commentsPostId"\n\t\t\t\t:channelId="entityId"\n\t\t\t/>\n\t\t</Transition>\n\t`};t.ChatContent=Ft})(this.BX.Messenger.v2.Component.Content=this.BX.Messenger.v2.Component.Content||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Animation,BX.Messenger.v2.Lib,BX.UI.Uploader,BX.Messenger.v2.Lib,BX,BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Model,BX.Messenger.v2.Component.Dialog,BX.Messenger.v2.Const,BX.Messenger.v2.Component,BX.Messenger.v2.Component,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Provider.Service);
//# sourceMappingURL=chat-content.bundle.map.js