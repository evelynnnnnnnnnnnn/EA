{"version":3,"file":"layout.bundle.js","sources":["../src/layout.js"],"sourcesContent":["import { EventEmitter, BaseEvent } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { Analytics } from 'im.v2.lib.analytics';\nimport { LocalStorageManager } from 'im.v2.lib.local-storage';\nimport { ChatType, EventType, Layout, LocalStorageKey } from 'im.v2.const';\nimport { Logger } from 'im.v2.lib.logger';\n\nimport type { ImModelLayout, ImModelChat } from 'im.v2.model';\n\ntype EntityId = string;\n\nconst TypesWithoutContext: Set<string> = new Set([ChatType.comment]);\n\nexport class LayoutManager\n{\n\tstatic #instance: LayoutManager;\n\n\t#lastOpenedElement: { [layoutName: string]: EntityId } = {};\n\n\tstatic getInstance(): LayoutManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init(): void\n\t{\n\t\tLayoutManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tEventEmitter.subscribe(EventType.dialog.goToMessageContext, this.#onGoToMessageContext.bind(this));\n\t\tEventEmitter.subscribe(EventType.desktop.onReload, this.#onDesktopReload.bind(this));\n\t}\n\n\tasync setLayout(config: ImModelLayout): Promise\n\t{\n\t\tif (config.entityId)\n\t\t{\n\t\t\tthis.setLastOpenedElement(config.name, config.entityId);\n\t\t}\n\n\t\tif (this.#isSameChat(config))\n\t\t{\n\t\t\tthis.#onSameChatReopen(config);\n\t\t}\n\n\t\tthis.#sendAnalytics(config);\n\n\t\treturn Core.getStore().dispatch('application/setLayout', config);\n\t}\n\n\tgetLayout(): ImModelLayout\n\t{\n\t\treturn Core.getStore().getters['application/getLayout'];\n\t}\n\n\tsaveCurrentLayout(): void\n\t{\n\t\tconst currentLayout = this.getLayout();\n\n\t\tLocalStorageManager.getInstance().set(LocalStorageKey.layoutConfig, {\n\t\t\tname: currentLayout.name,\n\t\t\tentityId: currentLayout.entityId,\n\t\t});\n\t}\n\n\trestoreLastLayout(): Promise\n\t{\n\t\tconst layoutConfig = LocalStorageManager.getInstance().get(LocalStorageKey.layoutConfig);\n\t\tif (!layoutConfig)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tLogger.warn('LayoutManager: last layout was restored', layoutConfig);\n\n\t\tLocalStorageManager.getInstance().remove(LocalStorageKey.layoutConfig);\n\n\t\treturn this.setLayout(layoutConfig);\n\t}\n\n\tgetLastOpenedElement(layoutName: string): null | string\n\t{\n\t\treturn this.#lastOpenedElement[layoutName] ?? null;\n\t}\n\n\tsetLastOpenedElement(layoutName: string, entityId: string): void\n\t{\n\t\tthis.#lastOpenedElement[layoutName] = entityId;\n\t}\n\n\tisChatContextAvailable(dialogId: string): boolean\n\t{\n\t\tif (!this.getLayout().contextId)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst { type }: ImModelChat = this.#getChat(dialogId);\n\n\t\treturn !TypesWithoutContext.has(type);\n\t}\n\n\tdestroy(): void\n\t{\n\t\tEventEmitter.unsubscribe(EventType.dialog.goToMessageContext, this.#onGoToMessageContext);\n\t\tEventEmitter.unsubscribe(EventType.desktop.onReload, this.#onDesktopReload.bind(this));\n\t}\n\n\t#onGoToMessageContext(event: BaseEvent<{dialogId: string, messageId: number}>): void\n\t{\n\t\tconst { dialogId, messageId } = event.getData();\n\t\tif (this.getLayout().entityId === dialogId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { type }: ImModelChat = this.#getChat(dialogId);\n\t\tif (TypesWithoutContext.has(type))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst isCopilotLayout = type === ChatType.copilot;\n\n\t\tvoid this.setLayout({\n\t\t\tname: isCopilotLayout ? Layout.copilot.name : Layout.chat.name,\n\t\t\tentityId: dialogId,\n\t\t\tcontextId: messageId,\n\t\t});\n\t}\n\n\t#onDesktopReload()\n\t{\n\t\tthis.saveCurrentLayout();\n\t}\n\n\t#sendAnalytics(config: ImModelLayout)\n\t{\n\t\tconst currentLayout = this.getLayout();\n\t\tif (currentLayout.name === Layout.copilot.name && currentLayout.entityId === '')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (config.name === Layout.copilot.name && config.entityId === '')\n\t\t{\n\t\t\tAnalytics.getInstance().openCopilotTab(config.entityId);\n\t\t}\n\t}\n\n\t#isSameChat(config: ImModelLayout): boolean\n\t{\n\t\tconst { name, entityId } = this.getLayout();\n\t\tconst sameLayout = name === config.name;\n\t\tconst sameEntityId = entityId && entityId === config.entityId;\n\n\t\treturn sameLayout && sameEntityId;\n\t}\n\n\t#onSameChatReopen(config: ImModelLayout): void\n\t{\n\t\tconst { entityId: dialogId, contextId } = config;\n\t\tconst { type }: ImModelChat = this.#getChat(dialogId);\n\t\tconst isChannel = [ChatType.openChannel, ChatType.channel].includes(type);\n\t\tif (isChannel)\n\t\t{\n\t\t\tEventEmitter.emit(EventType.dialog.closeComments);\n\t\t}\n\n\t\tif (contextId)\n\t\t{\n\t\t\tEventEmitter.emit(EventType.dialog.goToMessageContext, {\n\t\t\t\tmessageId: contextId,\n\t\t\t\tdialogId,\n\t\t\t});\n\t\t}\n\t}\n\n\t#getChat(dialogId: string): ImModelChat\n\t{\n\t\treturn Core.getStore().getters['chats/get'](dialogId, true);\n\t}\n}\n"],"names":["TypesWithoutContext","Set","ChatType","comment","LayoutManager","getInstance","init","constructor","EventEmitter","subscribe","EventType","dialog","goToMessageContext","bind","desktop","onReload","setLayout","config","entityId","setLastOpenedElement","name","Core","getStore","dispatch","getLayout","getters","saveCurrentLayout","currentLayout","LocalStorageManager","set","LocalStorageKey","layoutConfig","restoreLastLayout","get","Promise","resolve","Logger","warn","remove","getLastOpenedElement","layoutName","isChatContextAvailable","dialogId","contextId","type","has","destroy","unsubscribe","event","messageId","getData","isCopilotLayout","copilot","Layout","chat","Analytics","openCopilotTab","sameLayout","sameEntityId","isChannel","openChannel","channel","includes","emit","closeComments"],"mappings":"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"}